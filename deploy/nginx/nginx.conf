# Minimal, production-friendly nginx.conf
# - No 'user' directive (running as non-root in container)
# - Logs to stdout/stderr (Docker-friendly)
# - PID and temp paths in writable locations (tmpfs per compose)
# - Healthcheck endpoint
# - Reverse proxy to Django app at web:8000
# - Static & media served directly

worker_processes auto;
pid /tmp/nginx.pid;
error_log /dev/stderr info;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Logs to containers' stdout/stderr
    access_log /dev/stdout;

    # Sensible defaults
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout  65;

    # Temp paths â€” writable in your compose via tmpfs
    client_body_temp_path /tmp/client_temp;
    proxy_temp_path       /tmp/proxy_temp;
    fastcgi_temp_path     /tmp/fastcgi_temp;
    uwsgi_temp_path       /tmp/uwsgi_temp;
    scgi_temp_path        /tmp/scgi_temp;

    # Resolve Docker service names inside the network
    resolver 127.0.0.11 ipv6=off valid=30s;

    # Size limits (adjust as needed)
    client_max_body_size 50m;

    # Proxy defaults
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    # ---- Server ----
    server {
        listen 80;
        server_name _;
    #     server_name twoja-domena.pl www.twoja-domena.pl;

        location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

        location /static/ {
            alias /app/staticfiles/;
            access_log off;
            expires 30d;
        }

        location /media/ {
            alias /app/media/;
            access_log off;
            expires 30d;
        }

        location / {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://web:8000;
            proxy_read_timeout 60s;
        }
    }
}
